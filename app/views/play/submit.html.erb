<div class="player-page submit-page">
  <header class="player-header">
    <h1>üì§ Aktion einreichen</h1>
    <p><%= @group.name %></p>
  </header>

  <% unless GameSetting.instance.game_running? %>
    <div class="alert alert-warning">
      ‚ö†Ô∏è Das Spiel l√§uft gerade nicht. Einreichungen sind nicht m√∂glich.
    </div>
  <% else %>

  <form id="submission-form" class="submission-form" enctype="multipart/form-data">
    <!-- Option Selection -->
    <div class="form-group">
      <label for="option_id">Aktion ausw√§hlen *</label>
      <select name="option_id" id="option_id" required>
        <option value="">-- Aktion w√§hlen --</option>
        <% @options.each do |option| %>
          <% setting = option.option_setting %>
          <option value="<%= option.id %>" 
                  data-requires-target-group="<%= option.requires_target_group? %>"
                  data-requires-posten="<%= option.requires_posten? %>"
                  data-requires-points-input="<%= option.requires_points_input? %>"
                  data-requires-photo="<%= setting&.requires_photo? %>">
            <%= option.name %>
            <% if setting&.points && setting.points > 0 %>
              (<%= setting.points %> Pkt.)
            <% end %>
          </option>
        <% end %>
      </select>
    </div>

    <!-- Target Group Selection (for "hat Gruppe fotografiert", etc.) -->
    <div class="form-group target-group" id="target-group" style="display: none;">
      <label for="target_group_id">Zielgruppe ausw√§hlen *</label>
      <select name="target_group_id" id="target_group_id">
        <option value="">-- Zielgruppe w√§hlen --</option>
        <% @target_groups.each do |target| %>
          <option value="<%= target.id %>"><%= target.name %></option>
        <% end %>
      </select>
    </div>

    <!-- Posten/Target Selection (for "hat Posten geholt", "hat Mine gesetzt") -->
    <div class="form-group posten-group" id="posten-group" style="display: none;">
      <label for="target_id">Posten ausw√§hlen *</label>
      <select name="target_id" id="target_id">
        <option value="">-- Posten w√§hlen --</option>
        <% @posten.each do |posten| %>
          <option value="<%= posten.id %>"><%= posten.name %></option>
        <% end %>
      </select>
    </div>

    <!-- Points Input (for "hat Mine gesetzt", "hat Kopfgeld gesetzt") -->
    <div class="form-group points-input-group" id="points-input-group" style="display: none;">
      <label for="points_set" id="points-label">Punkte eingeben *</label>
      <input type="number" 
             name="points_set" 
             id="points_set" 
             min="1" 
             placeholder="Anzahl Punkte"
             class="form-control">
      <p class="hint" id="points-hint">Gib die Anzahl der Punkte ein</p>
    </div>

    <!-- Photo Capture -->
    <div class="form-group photo-group" id="photo-group">
      <label>Foto aufnehmen</label>
      
      <div class="photo-preview" id="photo-preview">
        <div class="photo-placeholder" id="photo-placeholder">
          <span class="camera-icon">üì∑</span>
          <span id="photo-prompt-text">Tippe um Foto aufzunehmen</span>
        </div>
        <img id="preview-image" src="" alt="Vorschau" style="display: none;">
        <button type="button" id="remove-photo" class="btn-remove-photo" style="display: none;">‚úï</button>
      </div>
      
      <!-- Camera-only input for mobile (no gallery access) -->
      <input type="file" 
             name="photo" 
             id="photo-input" 
             accept="image/*" 
             capture="environment"
             style="display: none;">
      
      <p class="photo-hint" id="photo-hint">Foto ist optional f√ºr diese Aktion</p>
      <p class="photo-warning" id="photo-warning" style="display: none; color: #e74c3c; font-size: 0.8rem; margin-top: 0.25rem;">
        ‚ö†Ô∏è Nur Kamera-Aufnahmen erlaubt (keine Galerie)
      </p>
    </div>

    <!-- Description -->
    <div class="form-group">
      <label for="description">Beschreibung (optional)</label>
      <textarea name="description" id="description" 
                placeholder="Zus√§tzliche Informationen..." 
                rows="2"></textarea>
    </div>

    <!-- Submit Button -->
    <div class="form-actions">
      <button type="submit" class="btn btn-primary btn-large" id="submit-btn">
        üì§ Einreichen
      </button>
    </div>
  </form>

  <% end %>

  <!-- Status Messages -->
  <div id="status-message" class="status-message" style="display: none;"></div>

  <!-- Navigation -->
  <nav class="player-nav">
    <a href="<%= play_home_path %>" class="nav-item">üè† Home</a>
    <a href="<%= play_my_submissions_path %>" class="nav-item">üìã Meine</a>
    <a href="<%= play_targets_path %>" class="nav-item">üéØ Posten</a>
  </nav>
</div>

<style>
  .submit-page {
    padding-bottom: 80px;
  }

  .submission-form {
    padding: 1rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #e0e0e0;
  }

  .form-group select,
  .form-group textarea,
  .form-group input[type="number"] {
    width: 100%;
    padding: 1rem;
    font-size: 1rem;
    border: 2px solid #333;
    border-radius: 12px;
    background: #252540;
    color: #fff;
  }

  .form-group select:focus,
  .form-group textarea:focus,
  .form-group input[type="number"]:focus {
    outline: none;
    border-color: #6c5ce7;
  }

  .form-group .hint {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: #888;
  }

  .photo-preview {
    position: relative;
    width: 100%;
    aspect-ratio: 4/3;
    background: #252540;
    border: 2px dashed #444;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    cursor: pointer;
  }

  .photo-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    color: #888;
  }

  .camera-icon {
    font-size: 3rem;
  }

  #preview-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .btn-remove-photo {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 0, 0, 0.8);
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
  }

  .photo-hint {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: #888;
    text-align: center;
  }

  .photo-hint.required {
    color: #e74c3c;
  }

  .form-actions {
    margin-top: 2rem;
  }

  .btn-large {
    width: 100%;
    padding: 1.2rem;
    font-size: 1.2rem;
    font-weight: 700;
    border-radius: 12px;
  }

  .btn-primary {
    background: linear-gradient(135deg, #6c5ce7, #a29bfe);
    border: none;
    color: white;
    cursor: pointer;
  }

  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .status-message {
    margin: 1rem;
    padding: 1rem;
    border-radius: 12px;
    text-align: center;
  }

  .status-message.success {
    background: rgba(46, 213, 115, 0.2);
    color: #2ed573;
  }

  .status-message.error {
    background: rgba(231, 76, 60, 0.2);
    color: #e74c3c;
  }

  .alert {
    margin: 1rem;
    padding: 1rem;
    border-radius: 12px;
  }

  .alert-warning {
    background: rgba(241, 196, 15, 0.2);
    color: #f1c40f;
    text-align: center;
  }

  .player-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #252540;
    display: flex;
    justify-content: space-around;
    padding: 0.75rem 0;
    border-top: 1px solid #333;
  }

  .nav-item {
    color: #888;
    text-decoration: none;
    font-size: 0.9rem;
    text-align: center;
  }

  .nav-item.active {
    color: #6c5ce7;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('submission-form');
  const optionSelect = document.getElementById('option_id');
  const targetGroupDiv = document.getElementById('target-group');
  const targetGroupSelect = document.getElementById('target_group_id');
  const postenGroupDiv = document.getElementById('posten-group');
  const postenSelect = document.getElementById('target_id');
  const pointsInputGroup = document.getElementById('points-input-group');
  const pointsInput = document.getElementById('points_set');
  const pointsLabel = document.getElementById('points-label');
  const pointsHint = document.getElementById('points-hint');
  const photoGroup = document.getElementById('photo-group');
  const photoInput = document.getElementById('photo-input');
  const photoPreview = document.getElementById('photo-preview');
  const photoPlaceholder = document.getElementById('photo-placeholder');
  const previewImage = document.getElementById('preview-image');
  const removePhotoBtn = document.getElementById('remove-photo');
  const photoHint = document.getElementById('photo-hint');
  const photoWarning = document.getElementById('photo-warning');
  const submitBtn = document.getElementById('submit-btn');
  const statusMessage = document.getElementById('status-message');

  // Detect mobile device
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  
  // On mobile: enforce camera-only (prevent gallery uploads)
  if (isMobile) {
    photoWarning.style.display = 'block';
  }

  // Option change handler
  optionSelect.addEventListener('change', function() {
    const selected = this.options[this.selectedIndex];
    const requiresTargetGroup = selected.dataset.requiresTargetGroup === 'true';
    const requiresPosten = selected.dataset.requiresPosten === 'true';
    const requiresPointsInput = selected.dataset.requiresPointsInput === 'true';
    const requiresPhoto = selected.dataset.requiresPhoto === 'true';
    const optionName = selected.text.trim();

    // Show/hide target group selection (for "hat Gruppe fotografiert", etc.)
    targetGroupDiv.style.display = requiresTargetGroup ? 'block' : 'none';
    targetGroupSelect.required = requiresTargetGroup;
    if (!requiresTargetGroup) targetGroupSelect.value = '';

    // Show/hide posten selection (for "hat Posten geholt", "hat Mine gesetzt")
    postenGroupDiv.style.display = requiresPosten ? 'block' : 'none';
    postenSelect.required = requiresPosten;
    if (!requiresPosten) postenSelect.value = '';

    // Show/hide points input (for "hat Mine gesetzt", "hat Kopfgeld gesetzt")
    pointsInputGroup.style.display = requiresPointsInput ? 'block' : 'none';
    pointsInput.required = requiresPointsInput;
    if (!requiresPointsInput) pointsInput.value = '';
    
    // Update label/hint based on option
    if (optionName.includes('Mine gesetzt')) {
      pointsLabel.textContent = 'Mine Punkte eingeben *';
      pointsHint.textContent = 'Gib die Anzahl der Punkte f√ºr diese Mine ein';
    } else if (optionName.includes('Kopfgeld gesetzt')) {
      pointsLabel.textContent = 'Kopfgeld Punkte eingeben *';
      pointsHint.textContent = 'Gib die Anzahl der Punkte f√ºr dieses Kopfgeld ein';
    } else {
      pointsLabel.textContent = 'Punkte eingeben *';
      pointsHint.textContent = 'Gib die Anzahl der Punkte ein';
    }

    // Update photo hint
    if (requiresPhoto) {
      photoHint.textContent = 'üì∑ Foto erforderlich f√ºr diese Aktion';
      photoHint.classList.add('required');
      photoInput.required = true;
    } else {
      photoHint.textContent = 'Foto ist optional f√ºr diese Aktion';
      photoHint.classList.remove('required');
      photoInput.required = false;
    }
  });

  // Photo capture - mobile uses camera API directly
  photoPreview.addEventListener('click', function() {
    if (isMobile && navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      // Determine camera facing mode based on selected option
      const selectedOption = optionSelect.options[optionSelect.selectedIndex];
      const optionText = selectedOption ? selectedOption.text : '';
      
      // "hat Posten geholt" uses selfie cam, others use back camera
      const useSelfieCamera = optionText.toLowerCase().includes('posten geholt');
      
      // Use camera stream for mobile to prevent gallery access
      openCameraCapture(useSelfieCamera);
    } else {
      // Fallback for desktop/testing
      photoInput.click();
    }
  });

  // Camera capture modal for mobile
  // @param useSelfieCamera - true for front camera, false for back camera
  function openCameraCapture(useSelfieCamera = false) {
    const facingMode = useSelfieCamera ? 'user' : 'environment';
    
    // Create fullscreen camera overlay
    const overlay = document.createElement('div');
    overlay.id = 'camera-overlay';
    overlay.innerHTML = `
      <div class="camera-container">
        <video id="camera-stream" autoplay playsinline></video>
        <div class="camera-controls">
          <button type="button" id="cancel-capture" class="btn-camera-cancel">‚úï Abbrechen</button>
          <button type="button" id="take-photo" class="btn-camera-capture">üì∑</button>
        </div>
      </div>
      <canvas id="photo-canvas" style="display: none;"></canvas>
    `;
    overlay.style.cssText = `
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: #000; z-index: 9999; display: flex;
      flex-direction: column; align-items: center; justify-content: center;
    `;
    document.body.appendChild(overlay);

    const video = document.getElementById('camera-stream');
    const canvas = document.getElementById('photo-canvas');
    const takePhotoBtn = document.getElementById('take-photo');
    const cancelBtn = document.getElementById('cancel-capture');

    // Style camera controls
    const controls = overlay.querySelector('.camera-controls');
    controls.style.cssText = `
      position: absolute; bottom: 30px; left: 0; right: 0;
      display: flex; justify-content: center; gap: 30px; padding: 20px;
    `;
    
    takePhotoBtn.style.cssText = `
      width: 70px; height: 70px; border-radius: 50%; border: 4px solid white;
      background: rgba(255,255,255,0.3); font-size: 24px; cursor: pointer;
    `;
    
    cancelBtn.style.cssText = `
      padding: 15px 25px; border-radius: 25px; border: none;
      background: rgba(255,0,0,0.7); color: white; font-size: 16px; cursor: pointer;
    `;

    video.style.cssText = `
      max-width: 100%; max-height: 80vh; object-fit: contain;
      ${useSelfieCamera ? 'transform: scaleX(-1);' : ''}
    `;

    // Start camera with appropriate facing mode
    navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: facingMode, width: { ideal: 1920 }, height: { ideal: 1080 } },
      audio: false 
    })
    .then(stream => {
      video.srcObject = stream;
      
      takePhotoBtn.addEventListener('click', function() {
        // Capture frame from video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        const ctx = canvas.getContext('2d');
        // Mirror the image for selfie camera
        if (useSelfieCamera) {
          ctx.translate(canvas.width, 0);
          ctx.scale(-1, 1);
        }
        ctx.drawImage(video, 0, 0);
        
        // Convert to blob and set as file input
        canvas.toBlob(function(blob) {
          const file = new File([blob], 'camera_photo.jpg', { type: 'image/jpeg' });
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          photoInput.files = dataTransfer.files;
          
          // Show preview
          previewImage.src = canvas.toDataURL('image/jpeg');
          previewImage.style.display = 'block';
          photoPlaceholder.style.display = 'none';
          removePhotoBtn.style.display = 'block';
          
          // Stop camera and close overlay
          stream.getTracks().forEach(track => track.stop());
          overlay.remove();
        }, 'image/jpeg', 0.9);
      });
      
      cancelBtn.addEventListener('click', function() {
        stream.getTracks().forEach(track => track.stop());
        overlay.remove();
      });
    })
    .catch(err => {
      console.error('Camera error:', err);
      overlay.remove();
      // Fallback to file input if camera access denied
      alert('Kamera-Zugriff verweigert. Bitte erlaube Kamera-Zugriff in den Browser-Einstellungen.');
    });
  }

  photoInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImage.src = e.target.result;
        previewImage.style.display = 'block';
        photoPlaceholder.style.display = 'none';
        removePhotoBtn.style.display = 'block';
      };
      reader.readAsDataURL(this.files[0]);
    }
  });

  // Remove photo
  removePhotoBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    photoInput.value = '';
    previewImage.src = '';
    previewImage.style.display = 'none';
    photoPlaceholder.style.display = 'flex';
    removePhotoBtn.style.display = 'none';
  });

  // Form submission
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    submitBtn.disabled = true;
    submitBtn.textContent = '‚è≥ Wird gesendet...';
    statusMessage.style.display = 'none';

    const formData = new FormData(form);

    try {
      const response = await fetch('<%= play_create_submission_path %>', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        }
      });

      const data = await response.json();

      if (data.success) {
        statusMessage.textContent = '‚úÖ ' + data.message;
        statusMessage.className = 'status-message success';
        statusMessage.style.display = 'block';
        
        // Reset form
        form.reset();
        previewImage.style.display = 'none';
        photoPlaceholder.style.display = 'flex';
        removePhotoBtn.style.display = 'none';
        targetGroupDiv.style.display = 'none';
        postenGroupDiv.style.display = 'none';
        
        // Redirect after short delay
        setTimeout(() => {
          window.location.href = '<%= play_my_submissions_path %>';
        }, 1500);
      } else {
        statusMessage.textContent = '‚ùå ' + data.message;
        statusMessage.className = 'status-message error';
        statusMessage.style.display = 'block';
      }
    } catch (error) {
      statusMessage.textContent = '‚ùå Netzwerkfehler. Bitte erneut versuchen.';
      statusMessage.className = 'status-message error';
      statusMessage.style.display = 'block';
    }

    submitBtn.disabled = false;
    submitBtn.textContent = 'üì§ Einreichen';
  });
});
</script>
