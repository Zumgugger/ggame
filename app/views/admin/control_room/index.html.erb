<div class="admin-container">
  <!-- Header -->
  <div class="flex-between p-lg mb-xl">
    <div>
      <h1 class="flex gap-sm align-items-center">
        <div style="width: 40px; height: 40px; border-radius: 50%; background: #7c3aed; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.4rem; cursor: pointer; position: relative;" onclick="toggleLogoutMenu()">
          <%= admin_avatar_letter %>
          <div id="logout-menu" style="position: absolute; left: 0; top: 100%; margin-top: 6px; background: #fff; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); min-width: 140px; padding: 8px; display: none; z-index: 1001;">
            <%= link_to "Logout", destroy_admin_user_session_path, method: :delete, data: { confirm: "Logout?" }, style: "display: block; color: #c00; text-decoration: none; font-weight: 600; padding: 8px;" %>
          </div>
        </div>
        GGame Control Room
      </h1>
    </div>
    <div class="flex gap-md align-items-center">
      <div class="flex gap-sm align-items-center">
        <span class="indicator-live"></span>
        <span class="text-muted">Live</span>
      </div>
      <div id="queue-stats" class="flex gap-lg">
        <div>
          <span class="text-accent"><%= @pending_count %></span> <span class="text-muted">pending</span>
        </div>
        <div>
          <span class="text-accent"><%= @verified_today %></span> <span class="text-muted">approved today</span>
        </div>
        <div>
          <span class="text-accent"><%= @denied_today %></span> <span class="text-muted">denied today</span>
        </div>
      </div>
      <% if Time.now < DateTime.parse("2099-01-01 23:59:59") %>
        <a href="<%= admin_game_setting_path(GameSetting.instance) %>" style="text-decoration: none; cursor: pointer;">
          <div id="game-timer" class="text-accent" style="font-weight: bold;">
            ⏱️ Time till next break: <span id="timer-value">--:--:--</span>
          </div>
        </a>
        <% if @next_end_time.present? %>
          <script>
            window.nextEndTime = new Date('<%= @next_end_time.to_s %>').getTime();
          </script>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- JavaScript Functions (Must be before inline onclick handlers) -->
  <script>
    function openPhotoModal(src) {
      document.getElementById('modal-photo').src = src;
      document.getElementById('photo-modal').classList.remove('hidden');
    }

    function closePhotoModal() {
      document.getElementById('photo-modal').classList.add('hidden');
    }

    function openEventModal(data) {
      document.getElementById('event-time').textContent = data.time;
      document.getElementById('event-group').textContent = data.group;
      document.getElementById('event-option').textContent = data.option;
      document.getElementById('event-target').textContent = data.target;
      document.getElementById('event-description').textContent = data.description;
      document.getElementById('event-group-points').textContent = data.group_points;
      document.getElementById('event-target-group').textContent = data.target_group;
      document.getElementById('event-target-points').textContent = data.target_points;
      document.getElementById('event-modal').classList.remove('hidden');
    }

    function closeEventModal() {
      document.getElementById('event-modal').classList.add('hidden');
    }

    function openGroupModal(data) {
      document.getElementById('group-name').textContent = data.name;
      document.getElementById('group-points').textContent = data.points;
      document.getElementById('group-bounty').textContent = data.kopfgeld;
      document.getElementById('group-members').textContent = data.members;
      document.getElementById('group-false-info').textContent = data.false_info;
      document.getElementById('group-submissions').textContent = data.submissions;
      document.getElementById('group-modal').classList.remove('hidden');
    }

    function closeGroupModal() {
      document.getElementById('group-modal').classList.add('hidden');
    }

    function toggleSensibleColumns() {
      const toggle = document.getElementById('toggle-sensible');
      if (!toggle) return;
      const isChecked = toggle.checked;
      const sensibleCols = document.querySelectorAll('.sensible-col');
      sensibleCols.forEach(col => {
        if (isChecked) {
          col.classList.add('hidden');
        } else {
          col.classList.remove('hidden');
        }
      });
    }

    function toggleLogoutMenu() {
      const menu = document.getElementById('logout-menu');
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    function toggleGroupTable() {
      // Show overlay with expanded table
      const overlay = document.getElementById('groups-overlay');
      if (overlay) overlay.classList.remove('hidden');
    }

    function toggleEventsTable() {
      // Show overlay with expanded table
      const overlay = document.getElementById('events-overlay');
      if (overlay) overlay.classList.remove('hidden');
    }

    // Close logout menu when clicking elsewhere
    document.addEventListener('click', function(e) {
      const menu = document.getElementById('logout-menu');
      const avatar = e.target.closest('[onclick="toggleLogoutMenu()"]');
      if (!avatar && menu) {
        menu.style.display = 'none';
      }
    });

    // Initialize: hide sensible columns on load
    document.addEventListener('DOMContentLoaded', function() {
      toggleSensibleColumns();
    });

    // Close menu when pressing Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closePhotoModal();
        document.getElementById('logout-menu').style.display = 'none';
        closeGroupsOverlay();
        closeEventsOverlay();
      }
    });
    function closeGroupsOverlay() {
      const overlay = document.getElementById('groups-overlay');
      if (overlay) overlay.classList.add('hidden');
    }
    function closeEventsOverlay() {
      const overlay = document.getElementById('events-overlay');
      if (overlay) overlay.classList.add('hidden');
    }
  </script>
  <div class="admin-grid full">
    <!-- Central Approval Panel -->
    <div class="admin-section p-xl" id="approval-panel">
      <% if @submission_to_verify.present? %>
        <div id="submission-<%= @submission_to_verify.id %>" class="submission-card">
          <div class="flex-between mb-lg">
            <h2 class="flex gap-sm align-items-center">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              Next Submission
            </h2>
            <span class="badge"><%= time_ago_in_words(@submission_to_verify.created_at) %> ago</span>
          </div>

          <!-- Submission Info -->
          <div class="flex-between gap-xl mb-xl">
            <div class="flex-column gap-md" style="flex: 1;">
              <div>
                <span class="text-muted">Group:</span>
                <span class="text-accent" style="font-weight: bold; font-size: 1.2rem;">
                  <%= @submission_to_verify.group.name %>
                </span>
              </div>
              <div>
                <span class="text-muted">Option:</span>
                <span><%= @submission_to_verify.option.name %></span>
              </div>
              <% if @submission_to_verify.target.present? %>
                <div>
                  <span class="text-muted">Target/Posten:</span>
                  <span><%= @submission_to_verify.target.name %></span>
                </div>
              <% end %>
              <% if @submission_to_verify.target_group.present? %>
                <div>
                  <span class="text-muted">Target Group:</span>
                  <span><%= @submission_to_verify.target_group.name %></span>
                </div>
              <% end %>
              <div>
                <span class="text-muted">Description:</span>
                <span><%= @submission_to_verify.description.truncate(100) %></span>
              </div>
            </div>

            <!-- Photo -->
            <% if @submission_to_verify.photo.attached? %>
              <div class="photo-container" style="flex: 0 0 300px;">
                <img id="submission-photo" 
                     src="<%= url_for(@submission_to_verify.photo) %>" 
                     alt="Submission photo"
                     style="width: 100%; aspect-ratio: 3/4; object-fit: cover; cursor: pointer; border: 2px solid var(--color-accent-primary);"
                     onclick="openPhotoModal(this.src)"
                >
                <p class="text-center text-muted text-small mt-sm">Click to expand</p>
              </div>
            <% end %>
          </div>

          <!-- Verification Form -->
          <form id="verification-form" data-submission-id="<%= @submission_to_verify.id %>">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            
            <div class="form-group">
              <label for="admin_message">Custom Message to Group:</label>
              <textarea id="admin_message" 
                        name="admin_message" 
                        placeholder="Optional: Send a message back to the group..."
                        style="height: 80px;"></textarea>
            </div>

            <div class="flex gap-lg">
              <button type="button" 
                      class="btn btn-success" 
                      onclick="submitVerification('<%= @submission_to_verify.id %>', 'verified')"
                      style="flex: 1; padding: var(--spacing-md);">
                ✓ APPROVE
                <br>
                <span class="text-small">(or press A)</span>
              </button>
              <button type="button" 
                      class="btn btn-danger" 
                      onclick="submitVerification('<%= @submission_to_verify.id %>', 'denied')"
                      style="flex: 1; padding: var(--spacing-md);">
                ✗ DENY
                <br>
                <span class="text-small">(or press D)</span>
              </button>
            </div>
          </form>
        </div>
      <% else %>
        <!-- Empty Queue State -->
        <div class="flex-center flex-column gap-lg p-2xl text-center">
          <h2 class="flex gap-sm align-items-center" style="justify-content: center;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Queue is empty!
          </h2>
          <p class="text-muted">Showing most recent event...</p>
          
          <% if @last_event.present? %>
            <div class="admin-section p-lg" style="width: 100%; margin-top: var(--spacing-lg);">
              <h3><%= @last_event.group.name %> - <%= @last_event.option.name %></h3>
              <p class="text-muted"><%= time_ago_in_words(@last_event.created_at) %> ago</p>
              <p><%= @last_event.description %></p>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Bottom Navigation / Quick Actions -->
    <div class="flex gap-md mb-xl justify-content-center">
      <%= link_to new_event_path, class: 'btn p-md flex gap-sm align-items-center' do %>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Add Event Manually
      <% end %>
      <%= link_to admin_root_path, class: 'btn p-md flex gap-sm align-items-center' do %>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3"></path>
        </svg>
        Admin Settings
      <% end %>
      <button type="button" class="btn p-md flex gap-sm align-items-center" onclick="undoLastAction()" id="undo-btn" style="display: none;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 7v6h6"></path>
          <path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"></path>
        </svg>
        UNDO
      </button>
    </div>
  </div>

  <!-- Stats & Rankings Section -->
  <div class="admin-grid">
    <!-- Rankings -->
    <div class="admin-section">
      <h2 class="mb-lg flex gap-sm align-items-center" style="cursor: pointer;" onclick="toggleGroupTable()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-accent">
          <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
          <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
          <path d="M4 22h16"></path>
          <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
          <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
          <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
        </svg>
        Group Rankings
      </h2>
      <table id="groups-table" class="expandable-table">
        <thead>
          <tr>
            <th>Rang</th>
            <th>Gruppe</th>
            <th>Punkte</th>
            <th>Submissions</th>
            <th class="hidden-col">Kopfgeld</th>
            <th class="hidden-col">Mitglieder</th>
            <th class="hidden-col">Falschinformation</th>
          </tr>
        </thead>
        <tbody>
          <% @groups.each_with_index do |group, idx| %>
            <tr style="cursor: pointer;" onclick="window.location='<%= admin_group_path(group) %>'">
              <td><span class="badge"><%= idx + 1 %></span></td>
              <td><span class="text-accent" style="font-weight: bold;"><%= group.name %></span></td>
              <td><strong><%= group.points %></strong></td>
              <td><%= group.events.count %></td>
              <td class="hidden-col"><%= group.kopfgeld %></td>
              <td class="hidden-col"><%= group.player_sessions.count %></td>
              <td class="hidden-col"><%= group.false_information ? "✓ ja!" : "nein" %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <!-- Recent Events -->
    <div class="admin-section">
      <h2 class="mb-lg flex gap-sm align-items-center" style="cursor: pointer;" onclick="toggleEventsTable()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-accent">
          <line x1="12" y1="2" x2="12" y2="6"></line>
          <line x1="12" y1="18" x2="12" y2="22"></line>
          <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
          <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
          <line x1="2" y1="12" x2="6" y2="12"></line>
          <line x1="18" y1="12" x2="22" y2="12"></line>
          <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
          <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
        </svg>
        Recent Events
      </h2>
      <table id="events-table" class="expandable-table">
        <thead>
          <tr>
            <th>Zeit</th>
            <th>Gruppe</th>
            <th>Aktion</th>
            <th>Gruppenpunkte</th>
            <th class="hidden-col">Ziel</th>
            <th class="hidden-col">Beschrieb</th>
            <th class="hidden-col">Zielgruppe</th>
            <th class="hidden-col">Zielpunkte</th>
          </tr>
        </thead>
        <tbody>
          <% @recent_events.each do |event| %>
            <tr style="cursor: pointer;" onclick="window.location='<%= event_path(event) %>'">
              <td class="text-muted"><%= event.created_at.strftime("%H:%M:%S") %></td>
              <td><strong><%= event.group.name %></strong></td>
              <td><%= event.option.name %></td>
              <td class="text-accent"><strong><%= event.group_points %></strong></td>
              <td class="hidden-col"><%= event.target&.name || "-" %></td>
              <td class="hidden-col"><%= event.description %></td>
              <td class="hidden-col"><%= event.target_group&.name || "-" %></td>
              <td class="hidden-col"><%= event.target_points.present? ? event.target_points : "-" %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Photo Modal -->
<div id="photo-modal" class="photo-modal hidden" onclick="closePhotoModal()">
  <div class="photo-modal-content" onclick="event.stopPropagation();">
    <button class="btn-close" onclick="closePhotoModal()">✕</button>
    <img id="modal-photo" src="" alt="Full size photo" style="width: 100%; height: auto;">
  </div>
</div>

<!-- Expanded Overlays -->
<div id="groups-overlay" class="overlay hidden" onclick="closeGroupsOverlay()">
  <div class="overlay-content admin-section" onclick="event.stopPropagation();">
    <button class="btn-close" onclick="closeGroupsOverlay()">✕</button>
    <h2 class="mb-lg flex gap-sm align-items-center">
      Group Rankings
    </h2>
    <table class="expandable-table expanded">
      <thead>
        <tr>
          <th>Rang</th>
          <th>Gruppe</th>
          <th>Punkte</th>
          <th>Submissions</th>
          <th>Kopfgeld</th>
          <th>Mitglieder</th>
          <th>Falschinformation</th>
        </tr>
      </thead>
      <tbody>
        <% @groups.each_with_index do |group, idx| %>
          <tr style="cursor: pointer;" onclick="window.location='<%= admin_group_path(group) %>'">
            <td><span class="badge"><%= idx + 1 %></span></td>
            <td><span class="text-accent" style="font-weight: bold;"><%= group.name %></span></td>
            <td><strong><%= group.points %></strong></td>
            <td><%= group.events.count %></td>
            <td><%= group.kopfgeld %></td>
            <td><%= group.player_sessions.count %></td>
            <td><%= group.false_information ? "✓ ja!" : "nein" %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div id="events-overlay" class="overlay hidden" onclick="closeEventsOverlay()">
  <div class="overlay-content admin-section" onclick="event.stopPropagation();">
    <button class="btn-close" onclick="closeEventsOverlay()">✕</button>
    <h2 class="mb-lg flex gap-sm align-items-center">
      Recent Events
    </h2>
    <table class="expandable-table expanded">
      <thead>
        <tr>
          <th>Zeit</th>
          <th>Gruppe</th>
          <th>Aktion</th>
          <th>Gruppenpunkte</th>
          <th>Ziel</th>
          <th>Beschrieb</th>
          <th>Zielgruppe</th>
          <th>Zielpunkte</th>
        </tr>
      </thead>
      <tbody>
        <% @recent_events.each do |event| %>
          <tr style="cursor: pointer;" onclick="window.location='<%= event_path(event) %>'">
            <td class="text-muted"><%= event.created_at.strftime("%H:%M:%S") %></td>
            <td><strong><%= event.group.name %></strong></td>
            <td><%= event.option.name %></td>
            <td class="text-accent"><strong><%= event.group_points %></strong></td>
            <td><%= event.target&.name || "-" %></td>
            <td><%= event.description %></td>
            <td><%= event.target_group&.name || "-" %></td>
            <td><%= event.target_points.present? ? event.target_points : "-" %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<style>
  .photo-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .photo-modal.hidden {
    display: none;
  }

  .photo-modal-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
  }

  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal.hidden {
    display: none;
  }

  .modal-content {
    position: relative;
    background: white;
    border-radius: 8px;
    padding: 30px;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  }

  .modal-body {
    margin-top: 20px;
  }

  .detail-row {
    display: flex;
    margin-bottom: 15px;
    gap: 15px;
    align-items: baseline;
  }

  .detail-label {
    font-weight: 600;
    min-width: 150px;
    color: #666;
  }

  .detail-value {
    flex: 1;
    word-break: break-word;
  }

  .btn-close {
    position: absolute;
    top: 15px;
    right: 15px;
    background: transparent;
    border: 2px solid #ddd;
    color: #333;
    width: 40px;
    height: 40px;
    font-size: 1.5rem;
    cursor: pointer;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btn-close:hover {
    background: #f0f0f0;
    border-color: #999;
  }

  .sensible-col {
    opacity: 1;
    transition: opacity 0.3s ease;
  }

  .sensible-col.hidden {
    display: none;
  }

  .align-items-center {
    align-items: center;
  }

  .justify-content-center {
    justify-content: center;
  }

  .text-small {
    font-size: var(--font-size-small);
  }

  .flex-between {
    display: flex;
    justify-content: space-between;
  }

  /* Expandable Table Styles */
  .hidden-col {
    display: none !important;
  }

  #groups-table.expanded .hidden-col,
  #events-table.expanded .hidden-col {
    display: table-cell !important;
  }

  /* Hide headers by default, show when expanded */
  #groups-table thead,
  #events-table thead {
    display: none;
  }
  #groups-table.expanded thead,
  #events-table.expanded thead {
    display: table-header-group;
  }

  h2[onclick*="toggle"]:hover {
    opacity: 0.7;
    transition: opacity 0.2s;
  }

  /* Overlay styles */
  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .overlay:not(.hidden) {
    display: flex;
  }
  .overlay-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    overflow: auto;
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  }
  .btn-close {
    position: absolute;
    top: var(--spacing-sm);
    right: var(--spacing-sm);
  }
</style>
